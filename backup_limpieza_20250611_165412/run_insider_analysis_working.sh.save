
x

#!/bin/bash
# Script que funciona - usa la opciÃ³n 1 del menÃº

PROJECT_DIR="/Users/alejandroordonezvillar/Desktop/stockAnalyzer/stock_analyzer_a"
PYTHON_PATH="/usr/bin/python3"
LOG_DIR="$PROJECT_DIR/logs"

# Crear log con timestamp
LOG_FILE="$LOG_DIR/cron_analysis_$(date +%Y%m%d_%H%M%S).log"

# FunciÃ³n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "ğŸš€ INICIANDO ANÃLISIS AUTOMÃTICO CON OPCIÃ“N 1"
log "=============================================="
log "ğŸ“ Directorio: $PROJECT_DIR"
log "ğŸ Python: $PYTHON_PATH"
log "ğŸ“„ Log: $LOG_FILE"

# Cambiar al directorio del proyecto
cd "$PROJECT_DIR" || {
    log "âŒ Error: No se pudo acceder al directorio $PROJECT_DIR"
    exit 1
}

# Verificar que main.py existe
if [[ ! -f "main.py" ]]; then
    log "âŒ Error: main.py no encontrado en $PROJECT_DIR"
    exit 1
fi

log "ğŸ“Š Ejecutando anÃ¡lisis con opciÃ³n 1..."

# Ejecutar main.py con opciÃ³n 1 (que sabemos que funciona)
# Usar timeout de 30 minutos y simular entrada "1"
echo "1" | timeout 1800 "$PYTHON_PATH" main.py >> "$LOG_FILE" 2>&1
exit_code=$?

if [[ $exit_code -eq 0 ]]; then
    log "âœ… AnÃ¡lisis completado exitosamente"
elif [[ $exit_code -eq 124 ]]; then
    log "â° AnÃ¡lisis cancelado por timeout (30 minutos)"
else
    log "âŒ AnÃ¡lisis fallÃ³ con cÃ³digo: $exit_code"
fi

# Mostrar estadÃ­sticas de archivos generados
log "ğŸ“Š ARCHIVOS GENERADOS:"
if [[ -f "$PROJECT_DIR/reports/insiders_daily.csv" ]]; then
    size=$(wc -l < "$PROJECT_DIR/reports/insiders_daily.csv")
    log "   âœ… insiders_daily.csv: $size lÃ­neas"
else
    log "   âŒ insiders_daily.csv: No generado"
fi

if [[ -f "$PROJECT_DIR/reports/insiders_opportunities.csv" ]]; then
    size=$(wc -l < "$PROJECT_DIR/reports/insiders_opportunities.csv")
    log "   âœ… insiders_opportunities.csv: $size lÃ­neas"
else
    log "   âŒ insiders_opportunities.csv: No generado"
fi

# Verificar subida a GitHub Pages
if [[ -d "$PROJECT_DIR/docs" ]]; then
    html_count=$(find "$PROJECT_DIR/docs" -name "*.html" | wc -l)
    log "   âœ… GitHub Pages: $html_count archivos HTML"
else
    log "   âŒ GitHub Pages: Directorio docs no existe"
fi

# Limpiar logs antiguos (mantener solo 14 dÃ­as)
find "$LOG_DIR" -name "cron_analysis_*.log" -mtime +14 -delete 2>/dev/null

log "ğŸ AnÃ¡lisis automÃ¡tico finalizado"

exit $exit_code
