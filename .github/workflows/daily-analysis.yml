name: Daily Market Analysis - Full Pipeline

on:
  schedule:
    # Run Monday-Friday at 6:00 AM UTC (2:00 AM EST)
    - cron: '0 6 * * 1-5'
  workflow_dispatch:  # Manual trigger

jobs:
  full-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas yfinance requests beautifulsoup4 lxml numpy

      - name: ðŸ“Š Run Sector Rotation
        run: |
          echo "ðŸ“Š [1/10] Sector Rotation Scan..."
          python3 sector_rotation_detector.py
          python3 sector_rotation_dashboard_generator.py

      - name: ðŸŽ¯ Run 5D Super Analyzer
        run: |
          echo "ðŸŽ¯ [2/10] 5D Super Analyzer..."
          python3 run_super_analyzer_4d.py

      - name: ðŸ“ˆ Generate Super Dashboard
        run: |
          echo "ðŸ“ˆ [3/10] Super Dashboard..."
          python3 super_dashboard_generator.py

      - name: ðŸ“‰ Run Backtest Engine
        run: |
          echo "ðŸ“‰ [4/10] Backtest Engine..."
          python3 backtest_engine.py
          python3 backtest_dashboard_generator.py

      - name: ðŸ’° Run Position Sizing
        run: |
          echo "ðŸ’° [5/10] Position Sizing..."
          python3 position_sizer.py

      - name: ðŸ“… Run Earnings Calendar
        run: |
          echo "ðŸ“… [6/10] Earnings Calendar..."
          python3 earnings_calendar.py || echo "âš ï¸  Earnings calendar warning (non-critical)"

      - name: ðŸ”„ Run Mean Reversion Detector
        run: |
          echo "ðŸ”„ [7/10] Mean Reversion Detector..."
          python3 mean_reversion_detector.py
          python3 mean_reversion_dashboard_generator.py

      - name: ðŸ”„ Run Mean Reversion Backtest
        run: |
          echo "ðŸ”„ [8/10] Mean Reversion Backtest..."
          python3 mean_reversion_backtester.py
          python3 mean_reversion_backtest_dashboard_generator.py

      - name: ðŸ‹ Run Options Flow Detector
        run: |
          echo "ðŸ‹ [9/11] Options Flow Detector..."
          python3 options_flow_detector.py
          python3 options_flow_dashboard_generator.py

      - name: ðŸ¤– Run ML Scoring
        run: |
          echo "ðŸ¤– [10/11] ML Scoring System..."
          python3 ml_scoring.py

      - name: ðŸ“± Send Telegram Alerts
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ðŸ“± [11/11] Sending Telegram Alerts..."
          python3 auto_telegram_alerts.py

      - name: ðŸ’¾ Commit and Push All Results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

          # Add all generated files
          git add docs/
          git add data/backtest_cache/ || echo "No backtest cache updates"

          # Create comprehensive commit
          SCAN_DATE=$(date +%Y-%m-%d)
          git commit -m "chore: Daily full pipeline update - ${SCAN_DATE}" \
            -m "Complete Market Analysis: Sector Rotation, 5D Analyzer, Backtest, Position Sizing, Mean Reversion, Options Flow, Telegram Alerts" \
            -m "Automated via GitHub Actions" || echo "No changes to commit"

          git push

      - name: ðŸ“¢ Create Pipeline Summary
        if: always()
        run: |
          echo "# ðŸš€ Daily Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Date:** $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time:** $(date +%H:%M:%S) UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Components Executed:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Sector Rotation Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… 5D Super Analyzer" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Super Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Backtest Engine" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Position Sizing" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Earnings Calendar" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Mean Reversion Detector" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Mean Reversion Backtest" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Options Flow Detector" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Telegram Alerts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Generated Dashboards:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Super Dashboard](https://tantancansado.github.io/stock_analyzer_a/super_dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [Sector Rotation](https://tantancansado.github.io/stock_analyzer_a/sector_rotation_dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [Backtest](https://tantancansado.github.io/stock_analyzer_a/backtest_dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [Mean Reversion](https://tantancansado.github.io/stock_analyzer_a/mean_reversion_dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [Mean Reversion Backtest](https://tantancansado.github.io/stock_analyzer_a/mean_reversion_backtest_dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [Options Flow](https://tantancansado.github.io/stock_analyzer_a/options_flow_dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“± **Telegram alerts have been sent to configured chat**" >> $GITHUB_STEP_SUMMARY

env:
  PYTHONUNBUFFERED: 1
