name: Daily Market Analysis - Full Pipeline

on:
  schedule:
    # Run Monday-Friday at 07:00 UTC (08:00-09:00 Spain time, before US market open)
    - cron: '0 7 * * 1-5'
  workflow_dispatch:  # Manual trigger

jobs:
  full-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy yfinance requests beautifulsoup4 lxml
          pip install plotly matplotlib seaborn scikit-learn scipy openpyxl
          pip install groq

      # ============================================================================
      # CRITICAL STEPS (Must succeed)
      # ============================================================================

      - name: Run Market Regime Detector [CRITICAL]
        run: python3 market_regime_detector.py

      - name: Sector Rotation Scan [pre-integration]
        continue-on-error: true
        run: python3 sector_rotation_detector.py || echo "Sector rotation failed"

      - name: Mean Reversion Scan [pre-integration]
        continue-on-error: true
        run: python3 mean_reversion_detector.py || echo "Mean reversion failed"

      - name: Run 5D Super Analyzer [CRITICAL]
        run: python3 run_super_analyzer_4d.py

      - name: Run Super Score Integration [CRITICAL]
        run: python3 super_score_integrator.py

      - name: AI Quality Filter [CRITICAL]
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: python3 ai_quality_filter.py

      - name: Calculate Entry/Exit Prices [CRITICAL]
        run: python3 add_entry_exit_to_opportunities.py

      - name: Generate Investment Theses [CRITICAL]
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: python3 thesis_generator.py 50 --ai || echo "Thesis generation failed"

      - name: European Value Scanner
        continue-on-error: true
        run: python3 european_value_scanner.py || echo "European scanner failed"

      - name: AI Filter European Value
        continue-on-error: true
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: python3 ai_quality_filter.py --european || echo "European AI filter failed"

      - name: Generate Super Dashboard [CRITICAL]
        run: python3 super_dashboard_generator.py

      - name: Portfolio Tracker (record signals + update performance)
        continue-on-error: true
        run: python3 portfolio_tracker.py --all

      # ============================================================================
      # OPTIONAL STEPS (Can fail without breaking pipeline)
      # ============================================================================

      - name: Whale Scan + Institutional Index
        continue-on-error: true
        run: |
          echo "1" | python3 scan_all_whales.py || echo "Whale scan failed"
          python3 build_institutional_index.py || echo "Institutional index failed"

      - name: Recurring Insiders
        continue-on-error: true
        run: python3 analyze_recurring_insiders.py || echo "Recurring insiders failed"

      - name: Sector Rotation Dashboard
        continue-on-error: true
        run: python3 sector_rotation_dashboard_generator.py || echo "Sector dashboard failed"

      - name: Backtest Engine
        continue-on-error: true
        run: |
          python3 backtest_engine.py || echo "Backtest engine failed"
          python3 backtest_dashboard_generator.py || echo "Backtest dashboard failed"

      - name: Backtest Snapshot Analysis
        continue-on-error: true
        run: |
          python3 -c "
          from backtest_system import BacktestSystem
          bs = BacktestSystem()
          snap = bs.create_snapshot('docs/super_opportunities_5d_complete.csv')
          print(f'Snapshot: {len(snap) if snap is not None else 0} opportunities')
          analyzed = bs.analyze_ready_snapshots()
          print(f'Analyzed: {len(analyzed)} snapshots')
          " || echo "Backtest snapshot failed"

      - name: Position Sizing
        continue-on-error: true
        run: python3 position_sizer.py || echo "Position sizing failed"

      - name: Earnings Calendar
        continue-on-error: true
        run: python3 earnings_calendar.py || echo "Earnings calendar failed"

      - name: Mean Reversion
        continue-on-error: true
        run: |
          python3 mean_reversion_detector.py || echo "Mean reversion detector failed"
          python3 mean_reversion_dashboard_generator.py || echo "Mean reversion dashboard failed"
          python3 mean_reversion_backtester.py || echo "Mean reversion backtest failed"
          python3 mean_reversion_backtest_dashboard_generator.py || echo "MR backtest dashboard failed"

      - name: Options Flow Detector
        continue-on-error: true
        run: |
          python3 options_flow_detector.py || echo "Options flow detector failed"
          python3 options_flow_dashboard_generator.py || echo "Options flow dashboard failed"

      - name: VCP Scanner S&P500
        continue-on-error: true
        run: python3 vcp_scanner_usa.py --sp500 --parallel || echo "VCP Scanner failed"

      - name: Fundamental Scoring
        continue-on-error: true
        run: python3 fundamental_scorer.py --vcp --5d --value --top 100 || echo "Fundamental scoring failed"

      - name: ML Scoring
        continue-on-error: true
        run: python3 ml_scoring.py || echo "ML scoring failed"

      - name: Update 5D Data Enrichment
        continue-on-error: true
        run: python3 enrich_5d.py || echo "5D enrichment failed"

      - name: Trading Analysis (Ultra Enhanced)
        continue-on-error: true
        run: python3 sistema_principal.py --ultra-enhanced completo || echo "Trading analysis failed"

      - name: Send Telegram Alerts
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: python3 auto_telegram_alerts.py || echo "Telegram alerts failed"

      # ============================================================================
      # COMMIT & PUSH (Always runs)
      # ============================================================================

      - name: Commit and Push All Results
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

          git add docs/ data/ || echo "Nothing to add"
          git add docs/theses.json || echo "No theses"
          git add data/sector_cache.json || echo "No sector cache"
          git add data/backtest/ || echo "No backtest data"
          git add data/institutional/ || echo "No institutional data"

          SCAN_DATE=$(date +%Y-%m-%d)
          git commit -m "chore: Daily full pipeline - ${SCAN_DATE}" \
            -m "Automated via GitHub Actions" || echo "No changes to commit"

          git push || echo "Push failed"

      - name: Trigger GitHub Pages Deployment
        if: always()
        run: |
          echo "Triggering Pages deployment..."
          gh workflow run pages-deploy.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

env:
  PYTHONUNBUFFERED: 1
