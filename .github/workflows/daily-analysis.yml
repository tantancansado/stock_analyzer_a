name: Daily Market Analysis - Full Pipeline (Robust)

on:
  schedule:
    # Run Monday-Friday at 6:00 AM UTC (2:00 AM EST)
    - cron: '0 6 * * 1-5'
  workflow_dispatch:  # Manual trigger

jobs:
  full-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas yfinance requests beautifulsoup4 lxml numpy

      # ============================================================================
      # CRITICAL STEPS (Must succeed)
      # ============================================================================

      - name: ðŸ“ˆ Run Market Regime Detector [CRITICAL]
        run: |
          echo "ðŸ“ˆ [1/15] Market Regime Detector..."
          python3 market_regime_detector.py

      - name: ðŸŽ¯ Run 5D Super Analyzer [CRITICAL]
        run: |
          echo "ðŸŽ¯ [2/15] 5D Super Analyzer..."
          python3 run_super_analyzer_4d.py

      - name: ðŸŽ¯ Run Super Score Integration [CRITICAL]
        run: |
          echo "ðŸŽ¯ [3/15] Super Score Integration (VCP + ML + Fundamental + Filters + Validation)..."
          python3 super_score_integrator.py

      - name: ðŸ“ˆ Generate Super Dashboard [CRITICAL]
        run: |
          echo "ðŸ“ˆ [4/15] Generate Super Dashboard with Advanced Filters..."
          python3 super_dashboard_generator.py

      # ============================================================================
      # OPTIONAL STEPS (Can fail without breaking pipeline)
      # ============================================================================

      - name: ðŸ“Š Run Sector Rotation [OPTIONAL]
        continue-on-error: true
        run: |
          echo "ðŸ“Š [5/15] Sector Rotation Scan..."
          python3 sector_rotation_detector.py || echo "âš ï¸  Sector rotation detector failed"
          python3 sector_rotation_dashboard_generator.py || echo "âš ï¸  Sector dashboard failed"

      - name: ðŸ“‰ Run Backtest Engine [OPTIONAL]
        continue-on-error: true
        run: |
          echo "ðŸ“‰ [6/15] Backtest Engine..."
          python3 backtest_engine.py || echo "âš ï¸  Backtest engine failed"
          python3 backtest_dashboard_generator.py || echo "âš ï¸  Backtest dashboard failed"

      - name: ðŸ’° Run Position Sizing [OPTIONAL]
        continue-on-error: true
        run: |
          echo "ðŸ’° [7/15] Position Sizing..."
          python3 position_sizer.py || echo "âš ï¸  Position sizing failed"

      - name: ðŸ“… Run Earnings Calendar [OPTIONAL]
        continue-on-error: true
        run: |
          echo "ðŸ“… [8/15] Earnings Calendar..."
          python3 earnings_calendar.py || echo "âš ï¸  Earnings calendar failed (non-critical)"

      - name: ðŸ”„ Run Mean Reversion Detector [OPTIONAL]
        continue-on-error: true
        run: |
          echo "ðŸ”„ [9/15] Mean Reversion Detector..."
          python3 mean_reversion_detector.py || echo "âš ï¸  Mean reversion detector failed"
          python3 mean_reversion_dashboard_generator.py || echo "âš ï¸  Mean reversion dashboard failed"

      - name: ðŸ”„ Run Mean Reversion Backtest [OPTIONAL]
        continue-on-error: true
        run: |
          echo "ðŸ”„ [10/15] Mean Reversion Backtest..."
          python3 mean_reversion_backtester.py || echo "âš ï¸  Mean reversion backtest failed"
          python3 mean_reversion_backtest_dashboard_generator.py || echo "âš ï¸  Dashboard failed"

      - name: ðŸ‹ Run Options Flow Detector [OPTIONAL]
        continue-on-error: true
        run: |
          echo "ðŸ‹ [11/15] Options Flow Detector..."
          python3 options_flow_detector.py || echo "âš ï¸  Options flow detector failed"
          python3 options_flow_dashboard_generator.py || echo "âš ï¸  Options flow dashboard failed"

      - name: ðŸ¤– Run ML Scoring [OPTIONAL]
        continue-on-error: true
        run: |
          echo "ðŸ¤– [12/15] ML Scoring System..."
          python3 ml_scoring.py || echo "âš ï¸  ML scoring failed"

      - name: ðŸ“Š Run Fundamental Scoring [OPTIONAL]
        continue-on-error: true
        run: |
          echo "ðŸ“Š [13/15] Fundamental Scoring (Earnings, Growth, RS, Health)..."
          python3 fundamental_scorer.py --vcp --top 100 || echo "âš ï¸  Fundamental scoring failed"

      - name: ðŸ“± Send Telegram Alerts [OPTIONAL]
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ðŸ“± [14/15] Sending Telegram Alerts..."
          python3 auto_telegram_alerts.py || echo "âš ï¸  Telegram alerts failed (check secrets)"

      # ============================================================================
      # COMMIT & PUSH (Always runs)
      # ============================================================================

      - name: ðŸ’¾ Commit and Push All Results
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

          # Add all generated files
          git add docs/ || echo "No docs to add"
          git add data/backtest_cache/ || echo "No backtest cache updates"

          # Create comprehensive commit
          SCAN_DATE=$(date +%Y-%m-%d)
          git commit -m "chore: Daily full pipeline update - ${SCAN_DATE}" \
            -m "Complete Market Analysis with Advanced Filters: Market Regime, Sector Rotation, 5D Analyzer, MA Filter, A/D Filter, Backtest, Position Sizing, Mean Reversion, Options Flow, Telegram Alerts" \
            -m "Automated via GitHub Actions" || echo "No changes to commit"

          git push || echo "âš ï¸  Push failed - check for conflicts"

      # ============================================================================
      # SUMMARY (Always runs - shows what succeeded/failed)
      # ============================================================================

      - name: ðŸ“¢ Create Pipeline Summary
        if: always()
        run: |
          echo "# ðŸš€ Daily Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Date:** $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time:** $(date +%H:%M:%S) UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## âœ… Critical Components (Must succeed):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Market Regime Detector (SPY/QQQ/VIX)" >> $GITHUB_STEP_SUMMARY
          echo "- 5D Super Analyzer" >> $GITHUB_STEP_SUMMARY
          echo "- Super Score Integration" >> $GITHUB_STEP_SUMMARY
          echo "- Super Dashboard Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ”§ Optional Components (Best effort):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Sector Rotation Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Backtest Engine" >> $GITHUB_STEP_SUMMARY
          echo "- Position Sizing" >> $GITHUB_STEP_SUMMARY
          echo "- Earnings Calendar" >> $GITHUB_STEP_SUMMARY
          echo "- Mean Reversion Detector" >> $GITHUB_STEP_SUMMARY
          echo "- Mean Reversion Backtest" >> $GITHUB_STEP_SUMMARY
          echo "- Options Flow Detector" >> $GITHUB_STEP_SUMMARY
          echo "- ML Scoring System" >> $GITHUB_STEP_SUMMARY
          echo "- Fundamental Scoring" >> $GITHUB_STEP_SUMMARY
          echo "- Telegram Alerts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ“Š Generated Dashboards:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸŽ¯ Super Dashboard](https://tantancansado.github.io/stock_analyzer_a/super_dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“Š Sector Rotation](https://tantancansado.github.io/stock_analyzer_a/sector_rotation_dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“‰ Backtest](https://tantancansado.github.io/stock_analyzer_a/backtest_dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ”„ Mean Reversion](https://tantancansado.github.io/stock_analyzer_a/mean_reversion_dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ”„ Mean Reversion Backtest](https://tantancansado.github.io/stock_analyzer_a/mean_reversion_backtest_dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ‹ Options Flow](https://tantancansado.github.io/stock_analyzer_a/options_flow_dashboard.html)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸  **Note:** Check individual step logs above for any warnings/failures" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Tip:** Optional steps that failed won't break the pipeline" >> $GITHUB_STEP_SUMMARY

env:
  PYTHONUNBUFFERED: 1
