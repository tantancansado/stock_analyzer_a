name: Trading Analysis Ultra Enhanced

on:
  schedule:
    - cron: '30 14 * * 1-5'
    - cron: '30 21 * * 1-5'
  workflow_dispatch:
    inputs:
      analysis_mode:
        description: 'Tipo de análisis'
        required: true
        default: 'ultra-enhanced'
        type: choice
        options:
        - ultra-enhanced
        - insider-only
        - dj-only
        - enhanced-only
      dj_mode:
        description: 'Modo DJ Sectorial'
        required: true
        default: 'principales'
        type: choice
        options:
        - principales
        - detallado
        - completo

jobs:
  trading-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install Dependencies
      run: |
        echo "Installing dependencies..."
        python -m pip install --upgrade pip
        pip install pandas numpy requests beautifulsoup4 lxml
        pip install plotly matplotlib seaborn 
        pip install yfinance python-telegram-bot
        pip install scikit-learn scipy openpyxl
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        echo "Dependencies installed"
    
    - name: Create Config
      run: |
        echo "Creating configuration..."
        cat > config.py << 'EOF'
        import os
        from datetime import datetime
        
        TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN', '')
        TELEGRAM_CHAT_ID = os.getenv('TELEGRAM_CHAT_ID', '')
        GITHUB_TOKEN = os.getenv('GITHUB_TOKEN', '')
        GITHUB_REPOSITORY = os.getenv('GITHUB_REPOSITORY', '')
        RUNTIME_MODE = 'github_actions'
        EXECUTION_TIME = datetime.now().isoformat()
        
        print(f"Config loaded - Telegram: {'OK' if TELEGRAM_BOT_TOKEN else 'MISSING'}")
        EOF
        echo "Configuration created"
    
    - name: System Check
      run: |
        echo "System check..."
        echo "Python version: $(python --version)"
        echo "Working directory: $(pwd)"
        echo "Files available:"
        ls -la
        if [ -f "paste.txt" ]; then
          echo "paste.txt found"
          head -5 paste.txt
        else
          echo "paste.txt not found"
          find . -name "*.py" -type f | head -10
        fi
    
    - name: Execute Trading Analysis
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        PYTHONPATH: ${{ github.workspace }}
        PYTHONUNBUFFERED: 1
      run: |
        echo "Starting trading analysis..."
        MODE="${{ github.event.inputs.analysis_mode || 'ultra-enhanced' }}"
        DJ_MODE="${{ github.event.inputs.dj_mode || 'principales' }}"
        echo "Mode: $MODE"
        echo "DJ Mode: $DJ_MODE"
        echo "Time: $(date)"
        
        if [ "$MODE" = "ultra-enhanced" ]; then
          echo "Running ULTRA ENHANCED analysis..."
          python paste.txt --ultra-enhanced $DJ_MODE
        elif [ "$MODE" = "insider-only" ]; then
          echo "Running Insider Trading only..."
          python paste.txt --insider
        elif [ "$MODE" = "dj-only" ]; then
          echo "Running DJ Sectorial only..."
          python paste.txt --dj $DJ_MODE
        elif [ "$MODE" = "enhanced-only" ]; then
          echo "Running Enhanced Opportunities only..."
          python paste.txt --enhanced
        else
          echo "Running default mode..."
          python paste.txt --ultra-enhanced principales
        fi
        echo "Analysis completed"
    
    - name: Verify Results
      run: |
        echo "Verifying results..."
        echo "Generated files:"
        find . -name "*.html" -o -name "*.csv" -o -name "*.json" | sort
        for dir in reports docs; do
          if [ -d "$dir" ]; then
            echo "$dir/ found:"
            ls -la $dir/ | head -10
          else
            echo "$dir/ not found"
          fi
        done
        HTML_COUNT=$(find . -name "*.html" 2>/dev/null | wc -l || echo "0")
        CSV_COUNT=$(find . -name "*.csv" 2>/dev/null | wc -l || echo "0")
        echo "Generated files: $HTML_COUNT HTML, $CSV_COUNT CSV"
    
    - name: Configure Git
      run: |
        echo "Configuring Git..."
        git config --global user.name "Trading Bot"
        git config --global user.email "trading-bot@github-actions.com"
        git config --global init.defaultBranch main
        echo "Git configured"
    
    - name: Commit Results
      run: |
        echo "Saving results..."
        git add docs/ reports/ || true
        git add *.html *.csv *.json || true
        if git diff --staged --quiet; then
          echo "No new changes to commit"
        else
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          MODE="${{ github.event.inputs.analysis_mode || 'ultra-enhanced' }}"
          git commit -m "Trading Analysis [$MODE] - $TIMESTAMP

Automated analysis via GitHub Actions
Timestamp: $TIMESTAMP
Mode: $MODE
Generated by: github-actions

[skip ci]"
          echo "Pushing to repository..."
          git push origin HEAD:main || git push origin HEAD:master
          echo "Results saved to GitHub"
        fi
    
    - name: Success Summary
      run: |
        echo "ANALYSIS COMPLETED SUCCESSFULLY!"
        echo ""
        echo "Summary:"
        echo "   Executed: $(date)"
        echo "   Mode: ${{ github.event.inputs.analysis_mode || 'ultra-enhanced' }}"
        echo "   Runner: GitHub Actions"
        echo ""
        echo "View results:"
        echo "   Dashboard: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "   Repository: https://github.com/${{ github.repository }}"
        echo "   Actions: https://github.com/${{ github.repository }}/actions"
        echo ""
        echo "Telegram notification sent"
    
    - name: Error Handler
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ERROR IN TRADING ANALYSIS"
        if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
          python3 -c "
import requests
import os
from datetime import datetime

token = os.getenv('TELEGRAM_BOT_TOKEN')
chat_id = os.getenv('TELEGRAM_CHAT_ID')

if token and chat_id:
    message = f'''ERROR EN TRADING ANALYSIS

Fecha: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} UTC
GitHub Actions falló
Ver logs: https://github.com/${{ github.repository }}/actions

El análisis automático requiere atención'''
    
    url = f'https://api.telegram.org/bot{token}/sendMessage'
    try:
        resp = requests.post(url, json={'chat_id': chat_id, 'text': message}, timeout=10)
        if resp.status_code == 200:
            print('Error notification sent')
        else:
            print(f'Error sending notification: {resp.status_code}')
    except Exception as e:
        print(f'Error: {e}')
else:
    print('Telegram not configured')
"
        fi
        echo "Ver logs en: https://github.com/${{ github.repository }}/actions"
