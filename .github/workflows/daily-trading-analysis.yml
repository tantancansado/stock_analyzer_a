# .github/workflows/daily-trading-analysis.yml
name: ğŸ“Š Trading Analysis Ultra Enhanced

on:
  # ProgramaciÃ³n automÃ¡tica - DÃAS LABORABLES SOLAMENTE
  schedule:
    # 9:30 AM EST = 14:30 UTC (despuÃ©s del market open)
    - cron: '30 14 * * 1-5'
    # 4:30 PM EST = 21:30 UTC (despuÃ©s del market close)  
    - cron: '30 21 * * 1-5'
  
  # Permitir ejecuciÃ³n manual para testing
  workflow_dispatch:
    inputs:
      analysis_mode:
        description: 'Tipo de anÃ¡lisis'
        required: true
        default: 'ultra-enhanced'
        type: choice
        options:
        - ultra-enhanced
        - insider-only  
        - dj-only
        - enhanced-only
      
      dj_mode:
        description: 'Modo DJ Sectorial'
        required: true
        default: 'principales'
        type: choice
        options:
        - principales
        - detallado
        - completo

jobs:
  trading-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        echo "ğŸ“¦ Instalando dependencias..."
        python -m pip install --upgrade pip
        
        # Dependencias core
        pip install pandas numpy requests beautifulsoup4 lxml
        pip install plotly matplotlib seaborn 
        pip install yfinance python-telegram-bot
        pip install scikit-learn scipy openpyxl
        
        # Si existe requirements.txt, usarlo tambiÃ©n
        if [ -f requirements.txt ]; then
          echo "ğŸ“‹ Instalando desde requirements.txt..."
          pip install -r requirements.txt
        fi
        
        echo "âœ… Dependencias instaladas"
    
    - name: ğŸ”§ Create Config
      run: |
        echo "ğŸ”§ Creando configuraciÃ³n..."
        cat > config.py << 'EOF'
        import os
        from datetime import datetime
        
        # Telegram Configuration
        TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN', '')
        TELEGRAM_CHAT_ID = os.getenv('TELEGRAM_CHAT_ID', '')
        
        # GitHub Configuration  
        GITHUB_TOKEN = os.getenv('GITHUB_TOKEN', '')
        GITHUB_REPOSITORY = os.getenv('GITHUB_REPOSITORY', '')
        
        # Runtime info
        RUNTIME_MODE = 'github_actions'
        EXECUTION_TIME = datetime.now().isoformat()
        
        print(f"âœ… Config loaded - Telegram: {'âœ“' if TELEGRAM_BOT_TOKEN else 'âœ—'}")
        EOF
        echo "âœ… ConfiguraciÃ³n creada"
    
    - name: ğŸ” System Check
      run: |
        echo "ğŸ” Verificando sistema..."
        echo "Python version: $(python --version)"
        echo "Working directory: $(pwd)"
        echo "Files available:"
        ls -la
        
        # Verificar archivo principal
        if [ -f "paste.txt" ]; then
          echo "âœ… paste.txt encontrado"
          head -5 paste.txt
        else
          echo "âŒ paste.txt no encontrado"
          echo "Archivos Python disponibles:"
          find . -name "*.py" -type f | head -10
        fi
    
    - name: ğŸš€ Execute Trading Analysis  
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        PYTHONPATH: ${{ github.workspace }}
        PYTHONUNBUFFERED: 1
      run: |
        echo "ğŸš€ Iniciando anÃ¡lisis de trading..."
        
        # Configurar modo
        MODE="${{ github.event.inputs.analysis_mode || 'ultra-enhanced' }}"
        DJ_MODE="${{ github.event.inputs.dj_mode || 'principales' }}"
        
        echo "ğŸ“Š Modo: $MODE"
        echo "ğŸ“ˆ DJ Mode: $DJ_MODE"
        echo "ğŸ• Hora: $(date)"
        
        # Ejecutar anÃ¡lisis segÃºn el modo
        if [ "$MODE" = "ultra-enhanced" ]; then
          echo "ğŸŒŸ Ejecutando anÃ¡lisis ULTRA MEJORADO..."
          python paste.txt --ultra-enhanced $DJ_MODE
        elif [ "$MODE" = "insider-only" ]; then
          echo "ğŸ›ï¸ Solo Insider Trading..."
          python paste.txt --insider
        elif [ "$MODE" = "dj-only" ]; then
          echo "ğŸ“Š Solo DJ Sectorial..."  
          python paste.txt --dj $DJ_MODE
        elif [ "$MODE" = "enhanced-only" ]; then
          echo "ğŸ¯ Solo Enhanced Opportunities..."
          python paste.txt --enhanced
        else
          echo "ğŸ”„ Modo por defecto..."
          python paste.txt --ultra-enhanced principales
        fi
        
        echo "âœ… AnÃ¡lisis completado"
    
    - name: ğŸ“Š Verify Results
      run: |
        echo "ğŸ“Š Verificando resultados..."
        
        # Mostrar estructura generada
        echo "ğŸ“ Estructura de archivos:"
        find . -name "*.html" -o -name "*.csv" -o -name "*.json" | sort
        
        # Verificar directorios principales
        for dir in reports docs; do
          if [ -d "$dir" ]; then
            echo "âœ… $dir/ encontrado:"
            ls -la $dir/ | head -10
          else
            echo "âŒ $dir/ no encontrado"
          fi
        done
        
        # Stats de archivos generados
        HTML_COUNT=$(find . -name "*.html" -newer . 2>/dev/null | wc -l || echo "0")
        CSV_COUNT=$(find . -name "*.csv" -newer . 2>/dev/null | wc -l || echo "0")
        
        echo "ğŸ“ˆ Archivos generados: $HTML_COUNT HTML, $CSV_COUNT CSV"
    
    - name: ğŸŒ Configure Git
      run: |
        echo "ğŸŒ Configurando Git..."
        git config --global user.name "Trading Bot ğŸ¤–"
        git config --global user.email "trading-bot@github-actions.com"
        git config --global init.defaultBranch main
        
        echo "âœ… Git configurado"
    
    - name: ğŸ’¾ Commit Results
      run: |
        echo "ğŸ’¾ Guardando resultados..."
        
        # Agregar archivos generados
        git add docs/ reports/ || true
        git add *.html *.csv *.json || true
        
        # Verificar cambios
        if git diff --staged --quiet; then
          echo "â„¹ï¸ No hay cambios nuevos para commitear"
        else
          # Commit con informaciÃ³n detallada
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          MODE="${{ github.event.inputs.analysis_mode || 'ultra-enhanced' }}"
          
          git commit -m "ğŸ“Š Trading Analysis [$MODE] - $TIMESTAMP

ğŸ¤– Automated analysis via GitHub Actions
ğŸ“… Timestamp: $TIMESTAMP  
ğŸ”§ Mode: $MODE
ğŸ“Š Generated by: github-actions
ğŸŒ View results: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}

[skip ci]"
          
          # Push cambios
          echo "ğŸ“¤ Pushing to repository..."
          git push origin HEAD:main || git push origin HEAD:master
          
          echo "âœ… Resultados guardados en GitHub"
        fi
    
    - name: ğŸ‰ Success Summary
      run: |
        echo "ğŸ‰ Â¡ANÃLISIS COMPLETADO EXITOSAMENTE!"
        echo ""
        echo "ğŸ“Š Resumen:"
        echo "   ğŸ• Ejecutado: $(date)"
        echo "   ğŸ”§ Modo: ${{ github.event.inputs.analysis_mode || 'ultra-enhanced' }}"
        echo "   ğŸ¤– Runner: GitHub Actions"
        echo ""
        echo "ğŸŒ Ver resultados:"
        echo "   ğŸ“Š Dashboard: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "   ğŸ“‹ Repository: https://github.com/${{ github.repository }}"
        echo "   ğŸ“œ Actions: https://github.com/${{ github.repository }}/actions"
        echo ""
        echo "ğŸ“± NotificaciÃ³n enviada por Telegram âœ…"
    
    - name: ğŸš¨ Error Handler
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        echo "ğŸš¨ ERROR EN TRADING ANALYSIS"
        
        # Intentar enviar notificaciÃ³n de error por Telegram
        if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
          python3 -c "
import requests
import os
from datetime import datetime

token = os.getenv('TELEGRAM_BOT_TOKEN')
chat_id = os.getenv('TELEGRAM_CHAT_ID')

if token and chat_id:
    message = f'''ğŸš¨ ERROR EN TRADING ANALYSIS

ğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} UTC
ğŸ¤– GitHub Actions fallÃ³
ğŸ”— Ver logs: https://github.com/${{ github.repository }}/actions
ğŸ“‹ Revisar configuraciÃ³n y volver a intentar

âŒ El anÃ¡lisis automÃ¡tico requiere atenciÃ³n'''
    
    url = f'https://api.telegram.org/bot{token}/sendMessage'
    try:
        resp = requests.post(url, json={'chat_id': chat_id, 'text': message}, timeout=10)
        if resp.status_code == 200:
            print('âœ… NotificaciÃ³n de error enviada')
        else:
            print(f'âŒ Error enviando notificaciÃ³n: {resp.status_code}')
    except Exception as e:
        print(f'âŒ Error: {e}')
else:
    print('âš ï¸ Telegram no configurado')
"
        fi
        
        echo "ğŸ“‹ Ver logs completos en: https://github.com/${{ github.repository }}/actions"