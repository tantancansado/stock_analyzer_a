name: Weekly VCP Scanner

on:
  schedule:
    # Domingos a las 2:00 AM UTC (antes de que abra el mercado el lunes)
    - cron: '0 2 * * 0'

  # Permite ejecuciÃ³n manual
  workflow_dispatch:

jobs:
  vcp-scan:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas yfinance requests beautifulsoup4 lxml

      - name: ðŸš€ Run VCP Scanner
        run: |
          echo "ðŸ” Ejecutando VCP Scanner USA (non-interactive mode con procesamiento paralelo)..."
          python3 vcp_scanner_usa.py --sp500 --parallel

      - name: ðŸ“Š Check scan results
        run: |
          # Check for new standardized format
          LATEST_CSV=$(find docs/reports/vcp -name "vcp_calibrated_results_*.csv" -type f | sort -r | head -1)
          LATEST_HTML=$(find docs/reports/vcp -name "vcp_scanner_*.html" -type f | sort -r | head -1)

          if [ -f "$LATEST_CSV" ]; then
            echo "âœ… Scan completado: $LATEST_CSV"
            echo "ðŸ“ˆ VCP patterns encontrados:"
            NUM_PATTERNS=$(tail -n +2 "$LATEST_CSV" 2>/dev/null | wc -l | tr -d ' ')
            echo "$NUM_PATTERNS patterns detectados"

            echo ""
            echo "ðŸ“Š Top 5 VCP Patterns (por score):"
            echo "----------------------------------------"
            tail -n +2 "$LATEST_CSV" | sort -t',' -k3 -rn | head -5 | \
              awk -F',' '{printf "%s - Score: %.1f - %s\n", $1, $3, $4}'
          else
            echo "âŒ No se encontrÃ³ el scan VCP"
            exit 1
          fi

      - name: ðŸ’¾ Commit & Push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"

          # Add VCP scan results (CSV, HTML, symlinks)
          git add docs/reports/vcp/
          git add docs/vcp_scanner.html

          # Create commit with scan info
          SCAN_DATE=$(date +%Y-%m-%d)
          LATEST_CSV=$(find docs/reports/vcp -name "vcp_calibrated_results_*.csv" -type f | sort -r | head -1)
          NUM_STOCKS=$(tail -n +2 "$LATEST_CSV" 2>/dev/null | wc -l | tr -d ' ')

          git commit -m "chore: Weekly VCP scan - $SCAN_DATE

          ðŸ“Š VCP Patterns Detected: $NUM_STOCKS stocks
          ðŸ¤– Automated via GitHub Actions
          ðŸ“ Standardized output: docs/reports/vcp/

          Scan file: $(basename $LATEST_CSV)" || echo "No changes to commit"

          git push

      - name: ðŸ“¢ Create scan summary
        run: |
          LATEST_CSV=$(find docs/reports/vcp -name "vcp_calibrated_results_*.csv" -type f | sort -r | head -1)

          echo "# ðŸš€ Weekly VCP Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "$LATEST_CSV" ]; then
            NUM_STOCKS=$(tail -n +2 "$LATEST_CSV" | wc -l | tr -d ' ')
            echo "**VCP Patterns Found:** $NUM_STOCKS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Output Location:** \`docs/reports/vcp/\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Top 10 VCP Patterns (by VCP Score)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Ticker | VCP Score | Quality | Ready to Buy |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-----------|---------|--------------|" >> $GITHUB_STEP_SUMMARY

            # Extract top 10 (skip header, sort by VCP score column 3)
            tail -n +2 "$LATEST_CSV" | sort -t',' -k3 -rn | head -10 | \
              awk -F',' '{printf "| %s | %.1f | %s | %s |\n", $1, $3, $4, $12}' >> $GITHUB_STEP_SUMMARY
          fi

env:
  PYTHONUNBUFFERED: 1
